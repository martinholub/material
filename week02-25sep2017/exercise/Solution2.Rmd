---
title: "Solution 2"
author: "Hubert Rehrauer"
date: "25 9 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exploratory Data Analysis

Do an exploratory data analysis of a matrix of expression values. Load the data and display:
* distributions: *boxplot*, *density*, *limma::plotDensities*
* normalization: *limma::normalizeQuantiles*
* clustering: *hclust*
* heatmap: *heatmap.2* or *pheatmap*
* correlation matrix: *cor* and *image*
* reduced dimensionality representation: *cmdscale* and *prcomp*


## Data Import
```{r }
anno = read.table("SampleAnnotation.txt", as.is=TRUE, sep="\t", quote="",
                  row.names=1, header=TRUE)
x = read.table("expressiondata.txt", as.is=TRUE, sep="\t", quote="", row.names=1, header=TRUE, check.names = FALSE)
x = as.matrix(x)
```

## Define samples and colors and phenotype
```{r}
samples = rownames(anno)
colors = rainbow(nrow(anno))
isNorm = anno$TissueType == "norm"
isSick = anno$TissueType == "sick"
isAcute = anno$TissueType == "acute"
```

## Visualize distributions


```{r}
par(mar=c(8, 4.1, 4.1, 2.1))
boxplot(log2(x), las=2, ylab="log2 expression")
```

## Density plot for one sample

```{r}
plot(density(log2(x[,1])))
```

## limma's function to plot densities

```{r}
library(limma)
plotDensities(log2(x), legend = "topright", main="raw expression values")
```

# Quantile normalization

```{r}
require(limma)
xNorm = normalizeQuantiles(x)

plotDensities(log2(xNorm), legend = "topright", main="quantile normalized")
```


# Sample Clustering

The sample clustering shows the similarities of the expression patterns of the
samples in a tree. In order to compute the similarities of the samples one
can use all genes or only a subset of the genes. When using all genes where
is the risk that the absent genes drive the clustering of the samples. This is
because in many studies the absent genes make up the majority of the
measured genes. But those genes have a low intensity that is strongly influenced by
the background signal measured on each chip and not by real gene expression

```{r}
x.sd = apply(x, 1, sd, na.rm=TRUE)
ord = order(x.sd, decreasing=TRUE)
highVarGenes = ord[1:500]
par(mfrow=c(1,2));
d = as.dist(1-cor(x));
c=hclust(d, method="ward.D2");
plot(c, hang=-0.1, main="all genes", xlab="")

d = as.dist(1-cor(x[highVarGenes, ]));
c=hclust(d, method="ward.D2");
plot(c, hang=-0.1, main="high variance genes", xlab="")
```

## Heatmaps of the expression data

```{r}
library(pheatmap)
xNormLog2 = log2(xNorm)
diffLog2 = xNormLog2 - rowMeans(xNormLog2)
diffLog2.sd = apply(diffLog2, 1, sd, na.rm=TRUE)
highVarGenes = head(order(diffLog2.sd, decreasing = TRUE), 500)
res = pheatmap(diffLog2[highVarGenes, ])
```


# Checking the consistency of the replicates

```{r}
corrMatrix = cor(x)
signif(corrMatrix, digits=3)
```

Visualize the correlation matrix
```{r}
par(mar=c(8,8,2,2), pty="s")
grayScale <- gray((1:256)/256)
image(corrMatrix, col=grayScale,  axes=FALSE)
axis(1, at=seq(from=0, to=1, length.out=length(samples)), labels=samples, las=2)
axis(2, at=seq(from=0, to=1, length.out=length(samples)), labels=samples, las=2)
```

The correlation plot shows

* normals show high correlation among each other
* the normal are very different from both sick and acute
* the sick and acute are rather similar
* `sick-14` rather looks like a normal sample
* `sick-15` has overall low correlation but rather looks like an "acute"
* `acute-04-a` which is a technical replicate of `acute-04` is more similar to `sick-04` than to `acute-04`.





# Multi-dimensional scaling and Principal component analysis

```{r}
dScaled <- cmdscale(d)
plot(dScaled, main="multi-dimensional scaling")
text(dScaled[ ,1],  dScaled[ ,2],labels =rownames(dScaled), pos=1, cex=0.7)
```

We are interested in the principle components for the samples that's why we do transpose the matrix so that samples are in rows.

```{r}
pca <- prcomp(t(log2(x)))
summary(pca)
```



